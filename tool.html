<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Wasser-facts-Tool</title>

    <!-- Load Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Load external CSS File -->
    <link rel="stylesheet" href="tool.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>

</head>
<body class="backgroundMap">
<div class="container-fluid mt-3">
    <header class="pt-4">
        <div class="">
            <div class="d-flex justify-content-between">
                <div class="p-2">
                    <a href="index.html">
                        <img src="./img/Logo_klein.png">
                    </a>
                </div>
                <div class="p-2 ">
                    <!--                    <a type="button" class="btn btn-outline-info fontText" href="about.html" role="button">Über das Projekt</a>-->
                    <a type="button" class="btn btn-outline-secondary fontText" href="about.html" role="button">Über das
                        Projekt</a>
                </div>
            </div>
        </div>
    </header>
    <div class="mt-3 fontText content-map">
        <div>
            <div class="form-check form-check-inline pr-5">
                <label class="pr-2">Wasserstress
                    <sup>
                        <i id="infoWaterStress" class='fa fa-fw fa-info-circle infoBtn' style="color:#0AA7FF">
                            <span class="tooltiptext fontText">Absinken des Wasserpotentials bei Pflanzen aufgrund Wassermangels (Dürre).</span>
                        </i>
                    </sup>
                </label>
                <label class="switch">
                    <input type="checkbox" class="checkbox" value="waterStress">
                    <span class="slider round"></span>
                </label>
            </div>

            <div class="form-check form-check-inline pr-5">
                <label class="pr-2">Virtuelles Wasser
                    <sup>
                        <i id="infoVirtualWater" class='fa fa-fw fa-info-circle infoBtn' style="color:#0AA7FF">
                            <span class="tooltiptext fontText">Indirekter Wasserkonsum Deutschlands (virtuelles Wasser) durch importierte Produkte.</span>
                        </i>
                    </sup>
                </label>
                <label class="switch">
                    <input type="checkbox" class="checkbox" value="virtualWater">
                    <span class="slider round"></span>
                </label>
            </div>
            <!--Product button -->
            <div class="form-check form-check-inline pr-5">
                <div class="dropdown">
                    <a class="btn btn-default dropdown-toggle" type="button"
                       id="dropdownMenu1" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="true" style="color:white">
                        <label>Produkte</label>
                    </a>
                    <ul class="dropdown-menu checkbox-menu allow-focus fontProduct" aria-labelledby="dropdownMenu1">
                        <li class="form-check">
                            <label>Kaffee</label>
                            <label class="switch coffe">
                                <input type="checkbox" class="checkbox" value="coffee">
                                <span class="slider round coffe"></span>
                            </label>
                        </li>
                        <hr class="hrProduct">
                        <li class="form-check">
                            <label>Reis</label>
                            <label class="switch rice">
                                <input type="checkbox" class="checkbox" value="rice">
                                <span class="slider round rice"></span>
                            </label>
                        </li>
                        <hr class="hrProduct">
                        <li class="form-check">
                            <label>Baumwolle</label>
                            <label class="switch coton">
                                <input type="checkbox" class="checkbox" value="cotton">
                                <span class="slider round coton"></span>
                            </label>
                        </li>
                    </ul>
                </div>
                <label class="switch">
                    <input type="checkbox" class="checkbox" value="products">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <hr class="hrTool">
        <div class="d-flex justify-content-center content-only-map">
            <div class="p-2 align-content-stretch" id="map">
                <svg id="tool" width="900" height="670"></svg>
            </div>
            <div class="d-flex p-2 justify-content-end" id="map-button">
                <div class="btn-group-vertical align-self-end">
                    <button class="btn btnZoom" id="zoom-in">
                        <img src="./img/plus.svg" id="plus-svg">
                    </button>
                    <button class="btn btnZoom" id="zoom-out">
                        <img src="./img/minus.svg" id="minus-svg">
                    </button>
                </div>
            </div>
        </div>
    </div>
    
</div>

<script>
    /** World map*/
    let Worldmap;

    /**
     * Maps for the dataset
     */
    let introData = d3.map();
    let waterStressData = d3.map();
    let virtualWater = [];

    /**
     *
     * */
    var link = [];

    /**
     * Tooltip
     */
    let tooltip = d3.select('#map')
        .append('div')
        .attr('class', 'hidden tooltip')
        .style("visibiliry", "hidden");


    /**
     * ColorScaleWaterstress
     */
    let colorScaleWaterstress = d3.scaleThreshold()
        .domain([0, 1, 2, 3, 4, 5])
        .range(d3.schemeReds[7]);

    /**
     * SVG
     */
    let svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height")


    /**
     * Read the file
     */

    d3.queue()
        .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
        .defer(d3.csv, "data/introData.csv", function (d) {
            introData.set(d.code,
                {"state": d.name, "text": d.text});

        })
        .defer(d3.csv, "data/countryWaterStress.csv", function (d) {
            waterStressData.set(d.code, +d.score)
        })
        .defer(d3.csv, "data/virtualWaterCountryMin.csv")
        .await(ready);


    /*
    Create Projection using Mercartor (geoMercator)
    and center it (translate) and zoom in a certain amount (scale)
     */
    let projection = d3.geoMercator()
        .scale(150)
        .translate([490, 480]);

    /*
   Create a geoPath using the projection
    */
    var path = d3.geoPath()
        .projection(projection);

    /**
     * G Gruppen
     */
    let g1 = svg.append("g");
    let g2 = svg.append("g");
    let g3 = svg.append("g");

    /**
     * Line Gradients
     */
    var defs = svg.append("defs");
    var gradient = defs.append("linearGradient")
        .attr("id", "svgGradient")
        .attr("x1", "0%")
        .attr("x2", "100%")
        .attr("y1", "0%")
        .attr("y2", "100%");

    gradient.append("stop")
        .attr('class', 'start')
        .attr("offset", "0%")
        .attr("stop-color", "#FF0BFF")
        .attr("stop-opacity", 1);

    gradient.append("stop")
        .attr('class', 'end')
        .attr("offset", "100%")
        .attr("stop-color", "#3DD9E3")
        .attr("stop-opacity", 1);
    console.log(introData);

    /**
     * Marker for the products.
     * */
    var markers = [
        {long: -72, lat: 4, group: "coffee", size: 41}, // Colombia
        {long: 120, lat: -5, group: "coffee", size: 30}, // Indonesia
        {long: -76, lat: -10, group: "coffee", size: 22}, // Peru
        {long: -55, lat: -10, group: "coffee", size: 100}, // Brazil
        {long: 38, lat: 1, group: "coffee", size: 20}, // Kenya
        {long: 77, lat: 20, group: "coffee", size: 8}, // India
        {long: 1.17, lat: 8, group: "rice", size: 6}, // Togo
        {long: 12.83, lat: 42.83, group: "rice", size: 4}, // Italy
        {long: 77, lat: 20, group: "cotton", size: 39}, // India
        {long: 35, lat: 39, group: "cotton", size: 30}, // Turkey
        {long: 70, lat: 30, group: "cotton", size: 15}, // Pakistan
        {long: 64, lat: 41, group: "cotton", size: 14}, // Uzbekistan
        {long: 90, lat: 24, group: "cotton", size: 14}, // Bangladesh
        {long: 105, lat: 35, group: "cotton", size: 13} // China
    ];
    /* Color for the products */
    var color = d3.scaleOrdinal()
        .domain(["coffee", "rice", "cotton"])
        .range(["#FFAC27", "#C73737", "#FF2EFF"])

    // Add a scale for bubble size
    var size = d3.scaleLinear()
        .domain([1, 100])  // What's in the data
        .range([4, 50])  // Size in pixel

    /**
     *
     * @param error
     * @param topo
     * @param data1
     * @param data2
     * @param wwf
     */

    function ready(error, topo, data1, data2, wwf) {
        let countries = topo.features;
        wwf.forEach(function (row) {
            // console.log(row);
            source = [9, 51]
            target = [+row.Longitude, +row.Latitude]
            topush = {type: "LineString", coordinates: [source, target]}
            // console.log(topush);
            virtualWater.push(topush)
        })
        console.log('wwf', virtualWater);

        worldmap = g1
            .selectAll(".country")
            .data(countries)
            .enter()
            .append("path")
            // Draw each country
            .attr("class", "country")
            .attr("d", path)
            .attr("fill", "#9CB6DB")
            .attr("stroke", strokeColorCountry)
            .attr("stroke-width", strokeWidthCountry)
            // .style("stroke", "#fff")
            .on('mouseover', function (d) {
                if (introData.has(d.id))
                    tooltip.style('visibility', "visible")
                        .html("<span><i>" + introData.get(d.id)["state"] + "</i></span>"
                            + "<br/>"
                            + "<hr class =" + "hrToolTip" + ">"
                            + introData.get(d.id)["text"])
            })
            .on('mouseout', function (d) {
                return tooltip.style("visibility", "hidden");
            })
            .on('mousemove', function (d) {
                tooltip.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px");
            })

        const toolButtons = d3.selectAll('.switch .checkbox').on("change", function (d) {
            const selection = this.value;
        });

        // d3.selectAll(".dropdown-menu .checkbox").on("change", updateCircle);

        const productButtons = d3.selectAll(".dropdown-menu .checkbox");
        console.log('productsButton', productButtons);


        let LinePath;
        toolButtons.on('change', function (d) {
            if (this.value === "waterStress") {
                console.log('button changed to ' + 'waterStress');
                if (d3.select(this).property("checked")) {
                    console.log('true');
                    // d3.select('#infoWaterStress')
                    // .style("visibility", "visible")
                    worldmap.attr("fill", function (d) {
                        d.total = waterStressData.get(d.id) || 0;
                        return colorScaleWaterstress(d.total);
                    });
                } else {
                    worldmap.attr("fill", "#9CB6DB")
                        .style("stroke", "#fff")

                }
            }

            if (this.value === "virtualWater") {
                console.log('button changed to ' + 'wwf');
                if (d3.select(this).property("checked")) {
                    d3.select('#zoom-in').on('click', function () {
                        var scale = zoom.scale(), extent = zoom.scaleExtent(), translate = zoom.translate();
                        var x = translate[0], y = translate[1];
                        var factor = 1.2;

                        var target_scale = scale * factor;

                        if (scale === extent[1]) {
                            return false;
                        }
                        var clamped_target_scale = Math.max(extent[0], Math.min(extent[1], target_scale));
                        if (clamped_target_scale != target_scale) {
                            target_scale = clamped_target_scale;
                            factor = target_scale / scale;
                        }
                        x = (x - center[0]) * factor + center[0];
                        y = (y - center[1]) * factor + center[1];

                        zoom.scale(target_scale).translate([x, y]);

                        g.transition().attr("transform", "translate(" + zoom.translate().join(",") + ") scale(" + zoom.scale() + ")");
                        g.selectAll("path")
                            .attr("d", path.projection(projection));

                        svg.selectAll("circle")
                            .transition()
                            .attr("transform", "translate(" + zoom.translate().join(",") + ") scale(" + zoom.scale() + ")")
                            .attr("r", 5 / zoom.scale());

                        d3.select("#map-zoomer").node().value = zoom.scale();
                    });

                    linePath = g2.selectAll("myPath")
                        .data(virtualWater)
                        .enter()
                        .append("path")
                        .attr("d", function (d) {
                            return path(d)
                        })
                        .style("fill", "none")
                        .style("stroke", "url(#svgGradient)")
                        .style("stroke-width", 6)
                    console.log('true');
                } else {
                    linePath.remove();
                    console.log('false');
                }




            }

            if (this.value === "products") {
                console.log('button changed to ' + 'products');
                if (d3.select(this).property("checked")) {
                    console.log('true');
                    d3.select(".dropdown-menu").selectAll("input").property('checked', true);
                    // d3.selectAll(".dropdown-menu .checkbox").each(function(d){
                    //     cb=d3.select(this);
                    //     grp=cb.property("value");
                    //
                    //     if(cb.property("checked")){
                    //         console.log('cb selected', cb.property("value"));
                    //     }
                    // });
                } else {
                    console.log('false');
                    d3.select(".dropdown-menu").selectAll("input").property('checked', false);
                }
                // Add Circles
                g3
                    .selectAll("myCircles")
                    .data(markers)
                    .enter()
                    .append("circle")
                    .attr("class", function (d) {
                        return d.group
                    })
                    .attr("cx", function (d) {
                        return projection([d.long, d.lat])[0]
                    })
                    .attr("cy", function (d) {
                        return projection([d.long, d.lat])[1]
                    })
                    .attr("r", function (d) {
                        return size(d.size)
                    })
                    .style("fill", function (d) {
                        return color(d.group)
                    })
                    .attr("stroke", function (d) {
                        return color(d.group)
                    })
                    .attr("stroke-width", 3)
                    .attr("fill-opacity", .4)


                // productButtons.on('change',function(d){
                //         cb=d3.select(this);
                //         grp=cb.property("value");
                //
                //         if(cb.property("checked")){
                //             console.log('cb selected', cb.property("value"));
                //         }
                //     // if (this.value === "coffee"){
                //     //     console.log("coffee")
                //     // }
                //     // if (this.value === "rice"){
                //     //     console.log("rice")
                //     // }
                //     // if (this.value === "cotton"){
                //     //     console.log("cotton")
                //     // }
                // })

                // productButtons.on('change', function (d) {
                //
                //
                // })
                // d3.selectAll(".dropdown-menu .checkbox").each(function(d){
                //     cb=d3.select(this);
                //     grp=cb.property("value");
                //
                //     if(cb.property("checked")){
                //         console.log('cb selected', cb.property("value"));
                //     }
                // });
            }

            // if (this.value ==="coffee"){
            //     console.log('button changed to ' + 'coffee');
            //
            //     if (d3.select(this).property("checked")) {
            //         console.log(true);
            //     } else{
            //         console.log(false);
            //
            //     }
            // }
            // if (this.value ==="rice"){
            //     console.log('button changed to ' + 'rice');
            //     if (d3.select(this).property("checked")) {
            //         console.log(true);
            //     } else{
            //         console.log(false);
            //
            //     }
            // }
            // if (this.value ==="cotton"){
            //     console.log('button changed to ' + 'cotton');
            //     if (d3.select(this).property("checked")) {
            //         console.log(true);
            //
            //     } else{
            //         console.log(false);
            //
            //     }
            // }
            d3.selectAll(".dropdown-menu .checkbox").on("change", updateCircle);
            updateCircle();
        })
    }

    function updateCircle() {
        d3.selectAll(".dropdown-menu .checkbox").each(function (d) {
            cb = d3.select(this);
            grp = cb.property("value");
            // If the box is check, I show the group
            if (cb.property("checked")) {
                console.log('cb selected', cb.property("value"));
                svg.selectAll("." + grp).transition().duration(1000).style("opacity", 1).attr("r", function (d) {
                    return size(d.size)
                })
                // Otherwise I hide it
            } else {
                svg.selectAll("." + grp).transition().duration(1000).style("opacity", 0).attr("r", 0)
            }
        })
    }


    function strokeColorCountry(country) {
        if (introData.has(country.id)) {
            return '#FFFFFF';
        } else {
            return;
        }
    }

    function strokeWidthCountry(country) {
        if (introData.has(country.id)) {
            return '4';
        } else {
            return;
        }
    }


    // const buttons = d3.selectAll('input').on("change", function (d) {
    //     const selection = this.value;
    // });
    // buttons.on('change', function (d) {
    //     if (this.value === "waterStress") {
    //         console.log('button changed to ' + 'waterStress')
    //         if (d3.select(this).property("checked")) {
    //             console.log('true');
    //         } else {
    //             console.log('false');
    //         }
    //     }
    //
    //     if (this.value == "virtualWater") {
    //         console.log('button changed to ' + 'wwf')
    //         if (d3.select(this).property("checked")) {
    //             console.log('true');
    //         } else {
    //             console.log('false');
    //
    //         }
    //
    //
    //     }
    //
    //     if (this.value === "products") {
    //         console.log('button changed to ' + 'products')
    //         if (d3.select(this).property("checked")) {
    //             console.log('true');
    //         } else {
    //             console.log('false');
    //
    //         }
    //
    //
    //     }
    // })
</script>

</body>
</html>