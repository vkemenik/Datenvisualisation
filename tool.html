<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>Wasser-facts-Tool</title>
    <!-- Load Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!--Load Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>

    <!-- scripts -->
    <!--    <script src="./scripts/waterstress.js" type="text/javascript" defer></script>-->
</head>
<body>
<div class="container mt-3 background">
    <div class="d-flex justify-content-between">
        <div class="p-2 align-content-stretch fontTitle">
            <p id="titleWWWTool">Wer? Wie? Was?</p>
            <p id="titleWasserTool">Wasser</p>
        </div>
        <div class="p-2 align-self-center">
            <a type="button" class="btn btn-outline-secondary fontText" href="about.html" role="button">about</a>
        </div>
    </div>
    <div class="radios mt-3 fontText">
        <div class="form-check form-check-inline pr-5">
            <label class="form-check-label" for="inlineRadio1">Wasserstress </label>
            <input class="form-check-input ml-2" type="radio" name="radioButton" id="inlineRadio1" value="waterstress" checked>
        </div>
        <div class="form-check form-check-inline pr-5">
            <label class="form-check-label" for="inlineRadio2">Virtuelles Wasser </label>
            <input class="form-check-input ml-2" type="radio" name="radioButton" id="inlineRadio2" value="wwf">
        </div>
        <div class="form-check form-check-inline pr-5">
            <label class="form-check-label" for="inlineRadio3">Produkte </label>
            <input class="form-check-input ml-2" type="radio" name="radioButton" id="inlineRadio3" value="product">
        </div>
    </div>
    <hr>
    <div class="d-flex justify-content-between">
        <div class="p-2 align-content-stretch" id="map">
            <svg id="tool" width="900" height="600"></svg>
        </div>
        <div class="p-2 align-self-end">
            <div class="btn-group-vertical">
                <button class="btn btnZoom" id="zoom-in"><i class="fa fa-plus "></i></button>
                <button class="btn btnZoom" id="zoom-out"><i class="fa fa-minus"></i></button>
            </div>
        </div>
    </div>
</div>
<script>
    var margin = {top: 50, left: 50, right: 50, bottom: 50},
        height = 400 - margin.top - margin.bottom,
        width = 800 - margin.left - margin.right;

    /**
     *
     * */
    var worldmap;
    /**
     * Maps for the dataset
     * */

    var waterStressData = d3.map();

    /**
     * Tooltip
     * */

    var tooltip = d3.select('#map')
        .append('div')
        .attr('class', 'hidden tooltip')
        .style("visibility", "hidden");

    /**
     * ColorScaleWaterstress
     * */
    var colorScaleWaterstress = d3.scaleThreshold()
        .domain([0, 1, 2, 3, 4, 5])
        .range(d3.schemeOranges[5]);


    // create the svg
    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height")


    /*
    Read File
     */
    d3.queue()
        .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
        .defer(d3.csv, "data/country-water-stress.csv", function (d) {
            waterStressData.set(d.code, +d.score);
        })
        .await(ready);

    /*
    Create Projection using Mercartor (geoMercator)
    and center it (translate) and zoom in a certain amount (scale)
     */
    var projection = d3.geoMercator()
        .scale(150)
        .translate([490, 430]);


    /*
    Create a geoPath using the projection
     */
    var path = d3.geoPath()
        .projection(projection);

    function ready(error, topo) {
        // console.log(waterStressData);
        //console.log(topo);
        var countries = topo.features;
        // console.log(countries);

        /**
         *Add a path for each country
         */
        // svg
        //     .append("g")
        //     .attr("class", "grid")
        //     .append("path")
        //     .datum(topo.features)
        //     .attr("d", path)
        //     .attr("opacity", 0.8)
        //     .attr('stroke-width', '0.5px')
        //     .attr('stroke', '#ccc')
        //     .attr("fill", "none");

        worldmap = svg.append("g")
            .selectAll(".country")
            .data(countries)
            .enter()
            .append("path")
            .attr("class", "country")
            // Draw each country
            .attr("d", path)
            .attr("fill", function (d) {
                d.total = waterStressData.get(d.id) || 0;
                return colorScaleWaterstress(d.total);
            })
            .on('mouseover', function (d) {
                // d3.select(this).classed("selected", true)
                if (waterStressData.has(d.id))
                    tooltip.style("visibility", "visible")
                        .html("<span>" + d.properties.name + "</span>"
                            + ":<br/>" + waterStressData.get(d.id));
            })
            .on('mouseout', function (d) {
                // d3.select(this).classed("selected", false)
                return tooltip.style("visibility", "hidden");
            })
            .on('mousemove', function (d) {
                tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
            })

        const buttons = d3.selectAll('input').on("change", function (d) {
            const selection = this.value;
        });
        buttons.on('change', function (d) {
            console.log('button changed to ' + this.value);
            if (this.value == 'waterstress') {
                var colorScale = d3.scaleThreshold()
                    .domain([0, 1, 2, 3, 4, 5])
                    .range(d3.schemeBlues[5]);
                //legend
                var g = svg.append("g")
                    .attr("class", "legendThreshold")
                    .attr("transform", "translate(20,20)");
                g.append("text")
                    .attr("class", "caption")
                    .attr("x", 0)
                    .attr("y", -6)
                    .text("Wasser-Stress-Score");
                var labels = ['Low <10%', 'Low - Medium (10-20%)', 'Medium - High (20-40%)', 'High (40-80%)', 'Extremely High (>80%)'];
                var legend = d3.legendColor()
                    .labels(function (d) {
                        return labels[d.i];
                    })
                    .shapePadding(4)
                    .scale(colorScale);

                worldmap.attr("fill", function (d) {
                    d.total = waterStressData.get(d.id) || 0;
                    return colorScale(d.total);
                });
                svg.select(".legendTreshold")
                    .call(legend);

            }
        })

        /**
         * Add Circle for the products
         */

        /* svg.selectAll(".products-circle")
             .data()
             .enter()
             .append("circle")
             .attr("r", 2)
             .attr("cx", function (d) {
                 var coords = projection([d.long, d.lat])
                 return coords[0];
             })
             .attr("cy", function (d) {
                 var coords = projection([d.long, d.lat])
                 return coords[1];
             })
         svg.selectAll(".products-label")
             .data()
             .enter()
             .append("text")
             .attr("class", "products-label")
             .attr("x", function (d) {
                 var coords = projection([d.long, d.lat])
                 return coords[0];
             })
             .attr("y", function (d) {
                 var coords = projection([d.long, d.lat])
                 return coords[1];
             })
             .text(function(d){
                 return d.name
             })
         .attr("dx", 10)
         .attr("dy",5)*/

        function updateMap(selectedMap) {
            d3.selectAll('input').each(function (d) {
                /* cb = d3.select(this);
                 grp = cb.property("value");

                 if (cb.property("checked")){
                     if(grp === "")
                 }*/
                if (selectedMap == 'waterstress') {
                    console.log('in waterstress');
                    var countries = topojson.feature(topo, topo.objects.countries).features;

                    svg.selectAll(".country")
                        .data(countries)
                        .enter()
                        .append("path")
                        .attr("class", "country")
                        .attr("d", path)
                        .attr("fill", function (d) {
                            d.total = waterStressData.get(d.name);
                        })

                }
            })
        }

        // const buttons = d3.selectAll('input').on("change", function (d) {
        //     const selection = this.value;
        // });
        // buttons.on('change', function (d) {
        //     console.log('button chnaged to ' + this.value);
        //     updateMap(this.value);
        // })
    }
</script>
</body>
</html>